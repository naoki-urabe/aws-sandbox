#cloud-config
packages: null
runcmd:
- - /var/lib/cloud/scripts/eksctl/bootstrap.al2.sh
- - /var/lib/cloud/scripts/eksctl/bootstrap.helper.sh
write_files:
- content: '{}'
  owner: root:root
  path: /etc/eksctl/kubelet-extra.json
  permissions: "0644"
- content: |-
    B64_CLUSTER_CA=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJQXNZNk9ZUGkrUXN3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBM01UUXhNakV4TlRkYUZ3MHpOVEEzTVRJeE1qRTJOVGRhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURvTlhMcElOODBXWTZsZGJpUGxOVldvZWdLdVBoajA4TkNJbjIrb05tM0VLUkV0UGl5L2tHZS90VkkKZG40UWxhWjh4WjlBUXBBeW9WV3ZTbVEwdW1tMjdmNUlUcGdrVnpUaGc4VVNxdjlFUnYwSFFHTWk3NU1RbjFUeApMSGJ6N1F2WHNwOGVQNDlYaEFscTZRa3FLbGp6RWc0WDVmSnl3c0JFaWU1Z2pvSEV3V05DSnJ3ZHJPYktucXlNCmZJUGhuaCtYV0lBWmEzNjRqQ2UvUnhhL0VyY1JFYWJvckpsdVN0UzRGdFN1b3krRnE4WE5oYTd0bFM0czk3R2QKanlyZHhaM08yd2xMckNvZ2RCK0FyRjJPVW9oNXpLYnYwVHdWM3F1aUY3N2pQMmovYTlCa3pCRElLZkQwUmlYegpXL202YityaS9UcHVLcUVUZlVKRHZiOU1SL0FsQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRRTdaZ1FvVlN4THZFTTM2bktLZ0pVNzRRWitEQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ3NlYmEweEZYSApnOERORnhUQUZjQjd4eXdndW41MEphTDRNbDdwYi9OTm8vRmRueDBUaEpiUkRkbEJ3b1FxcUJ0YjZRTm5wTzU2CjRUV3IyU3hIYW0vbkVyNmFQWC8wK2cvOGJUakNSMlhPZCtMVTZzczNKNEVCS3c0czRqbk1LVDFRRlE1MXdBRnAKckxKUGt4N1UzdnQwcFZWdXVjai9yZDJxUFlidkVkaXhtcldURktlelJ6blQzbnhhQTBlRHhrYW82ZGdPTVdHKwpVeXRXR3Zybm5oZzFJTzI0YTZSYlphZ0dkeXhyM1ZVVndGVEo2TFVtcythaDdoN0ltbmpqVzJreEpGL2gzNGx0ClZBTXF0Vms5RWRXVE9HTFNBajZ1TEhlNzNhTlF5bzk1NGpPNzhmckxnejJSZ1ZLekVRZGZCUE1QTlY3d1NCeTUKbVBDcEJxUWhsRUt6Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    NODE_LABELS=alpha.eksctl.io/cluster-name=test-base,alpha.eksctl.io/nodegroup-name=ng-1
    NODE_TAINTS=
    CLUSTER_DNS=10.100.0.10
    CONTAINER_RUNTIME=containerd
    CLUSTER_NAME=test-base
    API_SERVER_URL=https://369297ACA26724FB8A713BF23D931E35.gr7.ap-northeast-1.eks.amazonaws.com
  owner: root:root
  path: /etc/eksctl/kubelet.env
  permissions: "0644"
- content: |
    #!/bin/bash

    set -o errexit
    set -o pipefail
    set -o nounset

    source /var/lib/cloud/scripts/eksctl/bootstrap.helper.sh

    echo "eksctl: running /etc/eks/bootstrap"
    /etc/eks/bootstrap.sh "${CLUSTER_NAME}" \
      --apiserver-endpoint "${API_SERVER_URL}" \
      --b64-cluster-ca "${B64_CLUSTER_CA}" \
      --dns-cluster-ip "${CLUSTER_DNS}" \
      --kubelet-extra-args "${KUBELET_EXTRA_ARGS}" \
      --container-runtime "${CONTAINER_RUNTIME}" \
      ${ENABLE_LOCAL_OUTPOST:+--enable-local-outpost "${ENABLE_LOCAL_OUTPOST}"} \
      ${CLUSTER_ID:+--cluster-id "${CLUSTER_ID}"}


    echo "eksctl: merging user options into kubelet-config.json"
    trap 'rm -f ${TMP_KUBE_CONF}' EXIT
    jq -s '.[0] * .[1]' "${KUBELET_CONFIG}" "${KUBELET_EXTRA_CONFIG}" > "${TMP_KUBE_CONF}"
    mv "${TMP_KUBE_CONF}" "${KUBELET_CONFIG}"

    systemctl daemon-reload
    echo "eksctl: restarting kubelet-eks"
    systemctl restart kubelet
    echo "eksctl: done"
  owner: root:root
  path: /var/lib/cloud/scripts/eksctl/bootstrap.al2.sh
  permissions: "0755"
- content: |
    #!/bin/bash

    set -o errexit
    set -o pipefail
    set -o nounset

    source /etc/eksctl/kubelet.env # file written by bootstrapper

    # Use IMDSv2 to get metadata
    TOKEN="$(curl --silent -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 600" http://169.254.169.254/latest/api/token)"
    function get_metadata() {
      curl --silent -H "X-aws-ec2-metadata-token: $TOKEN" "http://169.254.169.254/latest/meta-data/$1"
    }

    API_SERVER_URL="${API_SERVER_URL}"
    B64_CLUSTER_CA="${B64_CLUSTER_CA}"
    INSTANCE_ID="$(get_metadata instance-id)"
    INSTANCE_LIFECYCLE="$(get_metadata instance-life-cycle)"
    CLUSTER_DNS="${CLUSTER_DNS:-}"
    NODE_TAINTS="${NODE_TAINTS:-}"
    MAX_PODS="${MAX_PODS:-}"
    NODE_LABELS="${NODE_LABELS},node-lifecycle=${INSTANCE_LIFECYCLE},alpha.eksctl.io/instance-id=${INSTANCE_ID}"

    KUBELET_ARGS=("--node-labels=${NODE_LABELS}")
    [[ -n "${NODE_TAINTS}" ]] && KUBELET_ARGS+=("--register-with-taints=${NODE_TAINTS}")
    # --max-pods as a CLI argument is deprecated, this is a workaround until we deprecate support for maxPodsPerNode
    [[ -n "${MAX_PODS}" ]] && KUBELET_ARGS+=("--max-pods=${MAX_PODS}")
    KUBELET_EXTRA_ARGS="${KUBELET_ARGS[@]}"

    CLUSTER_NAME="${CLUSTER_NAME}"
    KUBELET_CONFIG='/etc/kubernetes/kubelet/kubelet-config.json'
    KUBELET_EXTRA_CONFIG='/etc/eksctl/kubelet-extra.json'
    TMP_KUBE_CONF='/tmp/kubelet-conf.json'
    CONTAINER_RUNTIME="${CONTAINER_RUNTIME:-dockerd}" # default for al2 just in case, not used in ubuntu
  owner: root:root
  path: /var/lib/cloud/scripts/eksctl/bootstrap.helper.sh
  permissions: "0755"
